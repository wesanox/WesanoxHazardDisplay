<?php
namespace ProcessWire;

class WesanoxHazardDisplay extends WireData implements Module
{
    public static function getModuleInfo()
    {
        return array(
            'title' => 'wesanox Hazard Display Matrix',
            'summary' => 'A Module to implement a Hazard Display Modal in ProcessWire.',
            'version' => '0.5.1',
            'author' => 'Frittenfritze',
            'href' => 'https://wesanox.de',
            'icon' => 'window-maximize',
            'singular' => true,
            'autoload' => true,
            'installs' => [
                'ProcessWesanoxHazardDisplay',
                'WesanoxFrameworkPackage'
            ],
            'requires' => [
                'ProcessWire>=3.0.246',
                'PHP>=8.2.0',
                'WesanoxFrameworkPackage>=0.0.1',
                'WesanoxHelperClasses>=0.0.1',
            ],
        );
    }

    protected array $external_modules = [
        'WesanoxFrameworkPackage' => 'https://github.com/wesanox/WesanoxFrameworkPackage/archive/refs/heads/main.zip',
    ];

    /**
     * @var Module|_Module|null $helper_classes
     */
    protected Module|_Module|null $helper_classes;


    /**
     * @throws WirePermissionException
     */
    function __construct()
    {
        parent::__construct();

        $this->helper_classes = $this->modules->get('WesanoxHelperClasses');
    }

    /**
     * Modul config
     */
    /**
     * install function for the module
     *
     * @return void
     * @throws WireException
     * @throws WirePermissionException
     */
    public function ___install() : void
    {
        /**
         * Install external modules
         */
        foreach ($this->external_modules as $module_name => $module_url) {
            if (!$this->modules->isInstalled($module_name)) {
                $this->helper_classes->downloadInstall($module_name, $module_url);
            }
        }
    }

    /**
     * @return void
     */
    public function ready()
    {
        if ($this->page->template != 'admin') {
            $this->addHookAfter('Page::render', $this, 'getHazardModal');
        }
    }

    /**
     * @param HookEvent $event
     *
     * @return void
     */
    public function getHazardModal(HookEvent $event): void
    {
        $html = $event->return;

        if ($this->page->id === 1) {
            $insert = $this->renderHazardModal($this->page);

            $html = ($this->page->id === 1) ? preg_replace('/<\/body>/i', "$insert\n</body>", $html, 1) : $event->return;

            $event->return = $html;
        }
    }

    /**
     * @param $p
     *
     * @return string
     */
    public function renderHazardModal($p): string
    {
        if (!empty($_COOKIE['hazard_modal_closed']) && $_COOKIE['hazard_modal_closed'] === '1') {
            return '';
        }

        $cfg = $this->modules->getConfig('ProcessWesanoxHazardDisplay');

        $checkbox_hazard = !empty($cfg['checkbox_hazard']);
        $link_extern_hazard = (string)($cfg['link_extern_hazard'] ?? '');
        $link_intern_hazard = (int)($cfg['link_intern_hazard'] ?? 0);
        $link_text_hazard = (string)($cfg['link_text_hazard'] ?? '');
        $text_hazard = (string)($cfg['text_hazard'] ?? '');

        if ($checkbox_hazard && $text_hazard !== '' && ($link_intern_hazard || $link_extern_hazard !== '')) {
            $link = ($link_extern_hazard !== '') ? $link_extern_hazard : (($link_intern_hazard) ? $this->pages->get($link_intern_hazard)->url : '');
            $aria_label = ($link_text_hazard !== '') ? $link_text_hazard : (($link_intern_hazard) ? $this->pages->get($link_intern_hazard) : '');

            $link_html = '
                    <div class="modal-footer">
                        <a class="btn btn-primary" href="' . $link . '" title="' . $aria_label . '" aria-label="' . $aria_label . '">weitere Information</a>
                    </div>';

            return '
                    <div class="modal" id="info-modal" tabindex="-1" aria-labelledby="info-modal-label" aria-hidden="true" style="display: block; background-color: rgba(0, 0, 0, 0.5);">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Information</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    ' . $text_hazard . '
                                </div>
                                ' . $link_html . ' 
                            </div>
                        </div>
                    </div>
                    <script src="site/modules/WesanoxHazardDisplay/src/scripts/main.js" type="text/javascript"></script>';
        } else {
            return '';
        }
    }
}